# 管理员禁止登录IP管理脚本

本目录包含了用于管理管理员禁止登录IP的相关脚本。

## 脚本说明

### 1. `clear-admin-banned-ips.sh` - 完整清空脚本
**功能**: 安全地清空所有管理员禁止登录IP相关的表
**特点**: 
- 带确认提示，防止误操作
- 显示清空前后的状态对比
- 彩色输出，易于阅读
- 错误处理和状态检查

**使用方法**:
```bash
./clear-admin-banned-ips.sh
```

### 2. `quick-clear-banned-ips.sh` - 快速清空脚本
**功能**: 快速清空所有管理员禁止登录IP相关的表
**特点**:
- 无需确认，直接执行
- 简洁的输出
- 适合自动化脚本调用

**使用方法**:
```bash
./quick-clear-banned-ips.sh
```

### 3. `show-banned-ips.sh` - 状态查看脚本
**功能**: 查看当前管理员禁止登录IP的状态
**特点**:
- 显示所有相关表的状态
- 彩色输出，信息清晰
- 包含统计信息

**使用方法**:
```bash
./show-banned-ips.sh
```

### 4. `test-db-connection.sh` - 数据库连接测试脚本
**功能**: 测试数据库连接和检查相关表是否存在
**特点**:
- 验证数据库连接是否正常
- 检查相关表是否存在
- 提供详细的错误信息

**使用方法**:
```bash
./test-db-connection.sh
```

## 涉及的数据表

### 1. `admin_ip_restrictions` - 管理员IP限制表
- 存储临时和永久IP限制
- 包含限制类型、时间、原因等信息
- 支持自动过期处理

### 2. `ip_blacklist` - IP黑名单表
- 存储被禁止的IP地址
- 包含禁止原因、时间等信息
- 用于普通用户和管理员登录限制

### 3. `admin_login_failures` - 管理员登录失败记录表
- 记录管理员登录失败的历史
- 用于统计和分析登录安全情况
- 影响IP限制的自动触发

## 使用场景

### 清空禁止IP的场景
1. **测试环境重置**: 在开发测试时清空所有限制
2. **误操作恢复**: 管理员误操作导致IP被错误禁止
3. **系统维护**: 定期清理过期的限制记录
4. **安全策略调整**: 需要重新设置安全策略时

### 查看状态的场景
1. **安全检查**: 了解当前系统的安全状态
2. **问题排查**: 分析登录失败的原因
3. **系统监控**: 监控IP限制的使用情况

## 安全注意事项

⚠️ **重要提醒**:
- 这些脚本会清空所有IP限制数据，请谨慎使用
- 建议在生产环境使用前先在测试环境验证
- 清空操作不可逆，请确保有备份
- 建议在维护窗口期间执行清空操作

## 脚本依赖

- Docker 环境
- MySQL 容器运行中
- 项目已启动 (`docker compose up -d`)

## 数据库配置

脚本使用以下数据库配置（来自 `docker-compose.yml`）：
- **容器名**: `gift_card_mysql`
- **数据库名**: `gift_card_system`
- **用户名**: `giftcard_user`
- **密码**: `GiftCard_User_2024!`

## 故障排除

### 常见问题

1. **找不到MySQL容器**
   ```
   错误: 未找到MySQL容器，请确保项目已启动
   ```
   **解决方案**: 运行 `docker compose up -d` 启动项目

2. **权限错误**
   ```
   Permission denied
   ```
   **解决方案**: 确保脚本有执行权限 `chmod +x *.sh`

3. **数据库连接失败**
   ```
   Can't connect to MySQL server
   ```
   **解决方案**: 检查MySQL容器是否正常运行 `docker ps`

## 示例输出

### 清空脚本输出示例
```
================================
  管理员禁止登录IP表清空脚本
================================

[WARNING] 此脚本将清空所有管理员禁止登录IP相关的表
[WARNING] 包括：
[WARNING]   - admin_ip_restrictions (管理员IP限制表)
[WARNING]   - ip_blacklist (IP黑名单表)
[WARNING]   - admin_login_failures (管理员登录失败记录表)

确认要清空这些表吗？(y/N): y

[INFO] 找到MySQL容器: gift_card_mysql
[INFO] 显示当前禁止IP状态...

=== 管理员IP限制表状态 ===
+-------------+------------------+--------+--------+---------------------+----------+
| IP地址      | 限制类型         | 状态   | 原因   | 开始时间            | 结束时间  |
+-------------+------------------+--------+--------+---------------------+----------+
| 192.168.1.1 | permanent       | active | 恶意攻击 | 2024-01-15 10:30:00 | NULL     |
+-------------+------------------+--------+--------+---------------------+----------+

[INFO] 正在清空管理员IP限制表 (admin_ip_restrictions)...
[INFO] ✓ 管理员IP限制表已清空
[INFO] 正在清空IP黑名单表 (ip_blacklist)...
[INFO] ✓ IP黑名单表已清空
[INFO] 正在清空管理员登录失败记录表 (admin_login_failures)...
[INFO] ✓ 管理员登录失败记录表已清空

[INFO] 所有表清空完成！
[INFO] 脚本执行完成
```

### 状态查看脚本输出示例
```
================================
  管理员禁止登录IP状态查看
================================

找到MySQL容器: gift_card_mysql

=== 管理员IP限制表状态 ===
+-------------+------------------+--------+--------+---------------------+----------+
| IP地址      | 限制类型         | 状态   | 原因   | 开始时间            | 结束时间  |
+-------------+------------------+--------+--------+---------------------+----------+
| 192.168.1.1 | permanent       | active | 恶意攻击 | 2024-01-15 10:30:00 | NULL     |
+-------------+------------------+--------+--------+---------------------+----------+

=== IP黑名单表状态 ===
+-------------+--------+--------+---------------------+
| IP地址      | 原因   | 状态   | 禁止时间            |
+-------------+--------+--------+---------------------+
| 10.0.0.1   | 测试   | active | 2024-01-15 09:00:00 |
+-------------+--------+--------+---------------------+

=== 管理员登录失败记录统计 ===
+----------------+-----------+------------------+
| 总失败次数     | 唯一IP数  | 唯一用户名数     |
+----------------+-----------+------------------+
| 25             | 8         | 3                |
+----------------+-----------+------------------+

状态查看完成
``` 