/**
 * Admin core functionality
 * Includes basic features, initialization, API requests, navigation, etc.
 */

class AdminApp {
    constructor() {
        this.isLoggingOut = false;
        this.socket = null;
        this.token = localStorage.getItem('adminToken');
        this.currentAdmin = localStorage.getItem('adminInfo') ? JSON.parse(localStorage.getItem('adminInfo')) : null;

        // Map to store email-password pairs for validation
        this.emailPasswordMap = new Map();

        // Ensure DOM is fully loaded before initializing
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => this.init());
        } else {
            this.init();
        }
    }

    init() {
        const token = localStorage.getItem('adminToken');
        if (token) {
            this.token = token;
            
            const adminInfo = localStorage.getItem('adminInfo');
            if (adminInfo) {
                try {
                    this.currentAdmin = JSON.parse(adminInfo);
                } catch (e) {
                    console.error('[init] 解析管理员信息错误:', e);
                }
            } else {
                console.log('[init] localStorage adminInfo 为空');
            }
            
            this.socket = io();
            this.setupSocketListeners();
            
            this.showDashboard();

            this.loadInitialData();
        } else {
            this.showLoginPage();
        }
        
        this.bindEvents();
        
        this.updateNavByPermission();

        this.renderNavMenu();

        this.addSystemSettingsMenuItem();
    }

    bindEvents() {
        // Admin login - with security check
        const loginForm = document.getElementById('adminLoginForm');
        if (loginForm) {
            loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                this.handleAdminLogin();
            });
        } else {
            console.error('Login form element not found');
        }

        // Logout - with security check
        const logoutBtn = document.getElementById('logoutBtn');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', () => {
                this.logout();
            });
        }

        // Navigation buttons
        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                this.switchSection(e.target.dataset.section);
            });
        });
        
        const refreshDashboardBtn = document.getElementById('refreshDashboard');
        if (refreshDashboardBtn) {
            refreshDashboardBtn.addEventListener('click', () => {
                this.loadDashboardData();
            });
        }

        // Tab buttons
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                this.switchTab(e.target.dataset.tab);
            });
        });

        // Miscellaneous button events

        // Gift card management events
        const addGiftCardsBtn = document.getElementById('addGiftCardsBtn');
        if (addGiftCardsBtn) {
            addGiftCardsBtn.addEventListener('click', () => {
                this.showAddGiftCardsModal();
            });
        }

        const addCategoryBtn = document.getElementById('addCategoryBtn');
        if (addCategoryBtn) {
            addCategoryBtn.addEventListener('click', () => {
                this.showAddCategoryModal();
            });
        }

        const filterGiftCardsBtn = document.getElementById('filterGiftCards');
        if (filterGiftCardsBtn) {
            filterGiftCardsBtn.addEventListener('click', () => {
                this.loadGiftCards(1);
            });
        }

        const clearGiftCardFiltersBtn = document.getElementById('clearGiftCardFilters');
        if (clearGiftCardFiltersBtn) {
            clearGiftCardFiltersBtn.addEventListener('click', () => {
                const categoryFilter = document.getElementById('categoryFilter');
                const statusFilter = document.getElementById('statusFilter');
                const emailFilter = document.getElementById('emailFilter');
                
                if (categoryFilter) categoryFilter.value = '';
                if (statusFilter) statusFilter.value = '';
                if (emailFilter) emailFilter.value = '';
                
                this.loadGiftCards(1);
            });
        }

        // Email filter enter key event
        const emailFilter = document.getElementById('emailFilter');
        if (emailFilter) {
            emailFilter.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    this.loadGiftCards(1);
                }
            });
        }

        // IP management events
        const banIpBtn = document.getElementById('banIpBtn');
        if (banIpBtn) {
            banIpBtn.addEventListener('click', () => {
                this.showBanIpModal();
            });
        }

        const refreshIpListBtn = document.getElementById('refreshIpList');
        if (refreshIpListBtn) {
            refreshIpListBtn.addEventListener('click', () => {
                this.loadIpBlacklist();
            });
        }

        // Change password button
        const changePasswordBtn = document.getElementById('changePasswordBtn');
        if (changePasswordBtn) {
            changePasswordBtn.addEventListener('click', () => {
                this.showChangePasswordModal();
            });
        }

        // Admin management area button events
        const addAdminBtn = document.getElementById('addAdminBtn');
        if (addAdminBtn) {
            addAdminBtn.addEventListener('click', () => this.showAddAdminModal());
        }
        const refreshAdminsBtn = document.getElementById('refreshAdmins');
        if (refreshAdminsBtn) {
            refreshAdminsBtn.addEventListener('click', () => this.loadAdmins());
        }
        const permissionManageBtn = document.getElementById('permissionManageBtn');
        if (permissionManageBtn) {
            permissionManageBtn.addEventListener('click', () => this.showPermissionModal());
        }


        // Modal close
        const closeBtn = document.querySelector('.close');
        if (closeBtn) {
            closeBtn.addEventListener('click', () => {
                this.closeModal();
            });
        }

        window.addEventListener('click', (e) => {
            const modal = document.getElementById('modal');
            if (modal && e.target === modal) {
                this.closeModal();
            }
        });

        // Initialize member management events (if method exists)
        if (typeof this.initMembersEvents === 'function') {
            this.initMembersEvents();
        }

        const closePermissionModalBtn = document.getElementById('closePermissionModal');
        if (closePermissionModalBtn) {
            closePermissionModalBtn.addEventListener('click', () => {
                document.getElementById('permissionModal').style.display = 'none';
            });
        }
    }

    setupSocketListeners() {
        // New login request
        this.socket.on('new-login-request', (data) => {
            console.log('[Socket] 收到 new-login-request:', data);
            const container = document.getElementById('loginRequestsList');
            if (!container) {
                console.warn('[Socket] loginRequestsList 容器不存在，自动刷新登录请求列表');
                this.loadLoginRequests && this.loadLoginRequests();
                return;
            }
            this.addLoginRequest(data);
            this.updatePendingCount();
        });

        // New verification request
        this.socket.on('new-verification-request', (data) => {
            this.addVerificationRequest(data);
            this.updatePendingCount();
        });
        
        // Update verification request
        this.socket.on('update-verification-request', (data) => {
            // Clear verification request list
            const container = document.getElementById('verificationRequestsList');
            if (container) {
                container.innerHTML = '<p>Refreshing verification requests...</p>';
                // Reload all verification requests
                setTimeout(() => {
                    this.loadVerificationRequests();
                }, 100);
            }
        });

        // Join admin room
        if (this.currentAdmin) {
            console.log('[Socket] 加入admin房间:', this.currentAdmin);
            this.socket.emit('join-admin', {
                id: this.currentAdmin.id,
                username: this.currentAdmin.username,
                role: this.currentAdmin.role
            });
        } else {
            console.warn('[Socket] currentAdmin为空，无法加入admin房间');
        }
    }

    async handleAdminLogin() {
        const usernameField = document.getElementById('username');
        const passwordField = document.getElementById('adminPassword');
        
        if (!usernameField || !passwordField) {
            alert('登录表单元素未找到');
            return;
        }
        
        const username = usernameField.value;
        const password = passwordField.value;

        try {
            const response = await fetch('/api/auth/admin/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ username, password })
            });

            const data = await response.json();

            if (response.ok) {
                this.token = data.token;
                this.currentAdmin = data.admin;
                localStorage.setItem('adminToken', this.token);
                localStorage.setItem('adminInfo', JSON.stringify(data.admin));
                window.location.reload(); // 登录成功后强制刷新页面
                return;
            } else {
                alert(data.error || '登录失败');
            }
        } catch (error) {
            alert('网络错误，请重试');
        }
    }

    logout() {
        // Clear authentication data
        this.token = null;
        this.currentAdmin = null;
        console.log('[logout] currentAdmin 被清空');
        localStorage.removeItem('adminToken');
        localStorage.removeItem('adminInfo');
        
        // Disconnect Socket.IO
        if (this.socket) {
            this.socket.disconnect();
        }
        
        // Show login page
        this.showLoginPage();
        
        // Clear form
        const loginForm = document.getElementById('adminLoginForm');
        if (loginForm) {
            loginForm.reset();
        }
        
        // Clear username and password fields
        const usernameField = document.getElementById('username');
        const passwordField = document.getElementById('adminPassword');
        if (usernameField) usernameField.value = '';
        if (passwordField) passwordField.value = '';
    }

    showLoginPage() {
        const loginPage = document.getElementById('adminLoginPage');
        const dashboardPage = document.getElementById('adminDashboard');
        
        if (loginPage && dashboardPage) {
            loginPage.classList.add('active');
            dashboardPage.classList.remove('active');
            
            // Reconnect Socket.IO if needed
            if (this.socket && !this.socket.connected) {
                this.socket.connect();
            }
        } else {
            console.error('Login page elements not found!');
        }
    }

    showDashboard() {
        if (!this.currentAdmin) return;
        const loginPage = document.getElementById('adminLoginPage');
        const dashboardPage = document.getElementById('adminDashboard');

        if (loginPage && dashboardPage) {
            loginPage.classList.remove('active');
            dashboardPage.classList.add('active');
        } else {
            console.error('页面元素未找到！');
        }

        if (this.currentAdmin) {
            const adminName = document.getElementById('adminName');
            const adminRole = document.getElementById('adminRole');
            
            if (adminName) adminName.textContent = this.currentAdmin.username;
            if (adminRole) adminRole.textContent = this.currentAdmin.role === 'super' ? '超级管理员' : '普通管理员';
            
        const adminManageNav = document.getElementById('adminManageNav');
        if (adminManageNav) {
                adminManageNav.style.display = this.currentAdmin.role === 'super' ? 'block' : 'none';
            }
        }
        
        this.switchSection('dashboard');
        
        if (this.socket && this.currentAdmin) {
            this.socket.emit('join-admin', {
                id: this.currentAdmin.id,
                username: this.currentAdmin.username,
                role: this.currentAdmin.role
            });
        }
    }

    async loadInitialData() {
        if (!this.currentAdmin) return;
        try {
            
            await this.loadLoginRequests();
            await this.loadVerificationRequests();
            
            if (this.hasPermissionPoint('members:view')) {
                this.loadMembers();
            }
            
            if (this.hasPermissionPoint('gift-cards:view')) {
                this.loadGiftCards();
            }
            
            if (this.hasPermissionPoint('categories:view')) {
                this.loadCategories();
            }
            
            if (this.hasPermissionPoint('ip-blacklist:view')) {
                this.loadIpBlacklist();
            }
            
            if (this.currentAdmin && this.currentAdmin.role === 'super') {
                this.loadAdmins();
            }
            
                this.updatePendingCount();
            
        } catch (error) {
            console.error('加载初始数据错误:', error);
        }
    }

    async apiRequest(url, options = {}) {
        if (this.isLoggingOut) return;
        const method = (options.method || 'GET').toUpperCase();
        const defaultHeaders = (method === 'POST' || method === 'PUT')
            ? { 'Content-Type': 'application/json' }
            : {};
        const response = await fetch(url, {
            ...options,
            headers: {
                ...defaultHeaders,
                ...(options.headers || {}),
                'Authorization': 'Bearer ' + this.token
            }
        });
        if (response.status === 401) {
            if (!this.isLoggingOut) {
                this.isLoggingOut = true;
                alert('登录已过期，请重新登录');
                this.logout();
                console.log('[apiRequest] 401后 currentAdmin:', this.currentAdmin);
            }
            throw new Error('登录已过期');
        }
        return response;
    }

    // Update pending counts
    updatePendingCount() {
        const loginCount = document.querySelectorAll('#loginRequestsList .request-item').length;
        const verificationCount = document.querySelectorAll('#verificationRequestsList .request-item').length;
        const totalCount = loginCount + verificationCount;

            const navPendingCount = document.getElementById('navPendingCount');
            if (navPendingCount) {
            navPendingCount.textContent = totalCount;
        }
        
        const pendingCount = document.getElementById('pendingCount');
        if (pendingCount) {
            pendingCount.textContent = totalCount;
        }
        
        const loginRequestsCount = document.getElementById('loginRequestsCount');
        if (loginRequestsCount) {
            loginRequestsCount.textContent = loginCount;
        }
        
        const verificationRequestsCount = document.getElementById('verificationRequestsCount');
        if (verificationRequestsCount) {
            verificationRequestsCount.textContent = verificationCount;
        }
        
        const dashboardLoginRequests = document.getElementById('dashboardLoginRequests');
        if (dashboardLoginRequests) {
            dashboardLoginRequests.textContent = loginCount;
        }
        
        const dashboardVerificationRequests = document.getElementById('dashboardVerificationRequests');
        if (dashboardVerificationRequests) {
            dashboardVerificationRequests.textContent = verificationCount;
        }
    }

    // Switch between admin sections
    switchSection(section) {
        if (!section) return;
        
        if (!this.hasPermission(section)) {
            const firstPermittedSection = this.getFirstPermittedSection();
            if (firstPermittedSection && firstPermittedSection !== section) {
                section = firstPermittedSection;
            } else {
                console.error('无权访问任何页面，请确认权限配置');
                this.logout();
                return;
            }
        }

        // Update button state
        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        
        const activeButton = document.querySelector(`.nav-btn[data-section="${section}"]`);
        if (activeButton) {
            activeButton.classList.add('active');
        }

        // Update section visibility
        document.querySelectorAll('.admin-section').forEach(section => {
            section.classList.remove('active');
        });
        
        const activeSection = document.getElementById(`${section}Section`);
        if (activeSection) {
            activeSection.classList.add('active');
        } else {
            console.error(`未找到对应区域: ${section}Section`);
        }
        
        if (section === 'dashboard') {
            this.loadDashboardData();
            if (!document.querySelector('.tab-content.active')) {
                this.switchTab('loginRequests');
            }
        } else if (section === 'giftcards') {
            const sectionHeader = document.querySelector('#giftcardsSection .section-header h2');
            if (sectionHeader) {
                sectionHeader.textContent = '礼品卡管理';
            }
            if (typeof this.loadGiftCards === 'function') {
                this.loadGiftCards(1);
            }
        }
    }
    
    hasPermission(section) {
        if (['dashboard', 'pending'].includes(section)) {
            return true;
        }
        if (this.currentAdmin && this.currentAdmin.role === 'super') {
            return true;
        }
        const sectionPermissionMap = {
            'members': 'members:view',
            'giftcards': 'gift-cards:view',
            'categories': 'categories:view',
            'ipmanagement': 'ip-blacklist:view',
            'adminmanage': false // 只有超级管理员才能访问
        };
        const requiredPermission = sectionPermissionMap[section];
        if (requiredPermission === false) return false;
        if (requiredPermission) {
            return this.hasPermissionPoint(requiredPermission);
        }
        return true;
    }
    
    hasPermissionPoint(permissionKey) {
        if (!this.currentAdmin) return false;
        
        if (this.currentAdmin.role === 'super') return true;
        
        try {
            const permissions = this.currentAdmin.permissions ? JSON.parse(this.currentAdmin.permissions) : {};
            return !!permissions[permissionKey];
        } catch (e) {
            console.error('解析权限数据错误:', e);
            return false;
        }
    }
    
    getFirstPermittedSection() {
        const dashboard = this.hasPermission('dashboard');
        if (dashboard) {
            return 'dashboard';
        }
        const pending = this.hasPermission('pending');
        if (pending) {
            return 'pending';
        }
        const sections = ['members', 'giftcards', 'categories', 'ipmanagement', 'adminmanage'];
        for (const section of sections) {
            const permitted = this.hasPermission(section);
            if (permitted) {
                return section;
            }
        }
        return null;
    }

    switchTab(tab) {
        // Update tab button state
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        const tabBtn = document.querySelector(`[data-tab="${tab}"]`);
        if (tabBtn) tabBtn.classList.add('active');

        // Update tab content display
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
        });
        const tabContent = document.getElementById(`${tab}Tab`);
        if (tabContent) tabContent.classList.add('active'); // 健壮性判断
        // Update notification count after switching page
        this.updatePendingCount();
    }

    showModal(title, content) {
        const modalBody = document.getElementById('modalBody');
        const modal = document.getElementById('modal');
        
        if (modalBody) modalBody.innerHTML = `<h3>${title}</h3>${content}`;
        if (modal) modal.style.display = 'block';
    }

    closeModal() {
        const modal = document.getElementById('modal');
        if (modal) modal.style.display = 'none';
    }

    // Show change password modal
    showChangePasswordModal() {
        const content = `
            <form id="changePasswordForm">
                <div class="form-group">
                    <label for="currentPassword">当前密码</label>
                    <input type="password" id="currentPassword" required>
                </div>
                <div class="form-group">
                    <label for="newPassword">新密码</label>
                    <input type="password" id="newPassword" required minlength="6">
                    <small>密码至少需要6个字符</small>
                </div>
                <div class="form-group">
                    <label for="confirmPassword">确认新密码</label>
                    <input type="password" id="confirmPassword" required minlength="6">
                </div>
                <div class="form-actions">
                    <button type="button" class="cancel-btn" onclick="adminApp.closeModal()">取消</button>
                    <button type="submit">确认修改</button>
                </div>
            </form>
        `;

        this.showModal('修改密码', content);

        // Bind form submission event
        const changePasswordForm = document.getElementById('changePasswordForm');
        if (changePasswordForm) {
            changePasswordForm.addEventListener('submit', (e) => {
                e.preventDefault();
                this.handleChangePassword();
            });
        }
    }

    // Handle password change
    async handleChangePassword() {
        const currentPasswordField = document.getElementById('currentPassword');
        const newPasswordField = document.getElementById('newPassword');
        const confirmPasswordField = document.getElementById('confirmPassword');
        
        if (!currentPasswordField || !newPasswordField || !confirmPasswordField) {
            alert('密码表单元素未找到');
            return;
        }
        
        const currentPassword = currentPasswordField.value;
        const newPassword = newPasswordField.value;
        const confirmPassword = confirmPasswordField.value;

        // Frontend validation
        if (!currentPassword || !newPassword || !confirmPassword) {
            alert('请填写所有字段');
            return;
        }

        if (newPassword.length < 6) {
            alert('新密码必须至少6个字符');
            return;
        }

        if (newPassword !== confirmPassword) {
            alert('两次输入的新密码不匹配');
            return;
        }

        if (currentPassword === newPassword) {
            alert('新密码不能与当前密码相同');
            return;
        }

        try {
            const response = await this.apiRequest('/api/auth/admin/change-password', {
                method: 'POST',
                body: JSON.stringify({
                    currentPassword,
                    newPassword
                })
            });

            if (response && response.ok) {
                const data = await response.json();
                alert('密码修改成功！请重新登录。');
                this.closeModal();
                this.logout(); // Log out after changing password
            } else {
                const error = await response.json();
                alert(error.error || '密码修改失败');
            }
        } catch (error) {
            console.error('Change password error:', error);
            alert('密码修改失败，请重试');
        }
    }



    // Load admin list
    async loadAdmins() {
        const container = document.getElementById('adminList');
        if (!container) return;
        container.innerHTML = 'Loading...';
        try {
            const response = await this.apiRequest('/api/admin/admins');
            if (response && response.ok) {
                const admins = await response.json();
                container.innerHTML = this.renderAdminList(admins);
            } else {
                container.innerHTML = 'Load failed';
            }
        } catch (e) {
            container.innerHTML = 'Load failed';
        }
    }

    // Render admin list
    renderAdminList(admins) {
        const currentId = this.currentAdmin ? this.currentAdmin.id : null;
        return `<table><thead><tr><th>ID</th><th>用户名</th><th>角色</th><th>创建时间</th><th>操作</th></tr></thead><tbody>
            ${admins.map(admin => `
                <tr>
                    <td>${admin.id}</td>
                    <td>${admin.username}</td>
                    <td>${admin.role === 'super' ? '超级管理员' : '普通管理员'}</td>
                    <td>${this.formatDateTime(admin.created_at)}</td>
                    <td>
                        ${admin.role === 'admin' && admin.id !== currentId ? `<button onclick=\"adminApp.deleteAdmin(${admin.id})\">删除</button>` : '<span style=\"color:#aaa\">无法操作</span>'}
                    </td>
                </tr>
            `).join('')}
        </tbody></table>`;
    }

    // Show add admin modal
    showAddAdminModal() {
        this.showModal('添加管理员', `
            <form id="addAdminForm">
                <div class="form-group">
                    <label>用户名</label>
                    <input type="text" id="addAdminUsername" required>
                </div>
                <div class="form-group">
                    <label>密码</label>
                    <input type="password" id="addAdminPassword" required minlength="6">
                </div>
                <button type="submit">添加</button>
            </form>
        `);
        const addAdminForm = document.getElementById('addAdminForm');
        if (addAdminForm) {
            addAdminForm.onsubmit = async (e) => {
                e.preventDefault();
                const usernameField = document.getElementById('addAdminUsername');
                const passwordField = document.getElementById('addAdminPassword');
                const now = new Date().toISOString();
                const username = usernameField.value.trim();
                const password = passwordField.value.trim();
                if (!username || !password) {
                    alert('用户名和密码不能为空');
                    return;
                }
                try {
                    const response = await this.apiRequest('/api/admin/admins', {
                        method: 'POST',
                        body: JSON.stringify({ username: username, password: password })
                    });
                    if (response && response.ok) {
                        alert('添加成功');
                        this.closeModal();
                        this.loadAdmins();
                    } else {
                        const data = await response.json();
                        alert(data.error || '添加失败');
                    }
                } catch (e) {
                    alert('添加失败');
                }
            };
        }
    }

    // Delete admin
    async deleteAdmin(id) {
        if (!confirm('确定要删除此管理员吗？')) return;
        try {
            const response = await this.apiRequest(`/api/admin/admins/${id}`, { method: 'DELETE' });
            if (response && response.ok) {
                alert('删除成功');
                this.loadAdmins();
            } else {
                const data = await response.json();
                alert(data.error || '删除失败');
            }
        } catch (e) {
            alert('删除失败');
        }
    }

    async showPermissionModal() {
        if (!this.currentAdmin || this.currentAdmin.role !== 'super') {
            alert('无权限访问该功能！');
            return;
        }
        const modal = document.getElementById('permissionModal');
        const body = document.getElementById('permissionModalBody');
        body.innerHTML = '加载中...';
        modal.style.display = 'block';
        try {
            const res = await fetch('/api/admin/admin-permissions', { headers: { Authorization: 'Bearer ' + this.token } });
            const admins = await res.json();
            if (!Array.isArray(admins)) throw new Error('数据异常');
            let html = '<div style="display:flex;gap:2em;align-items:flex-start;">';
            html += '<div style="min-width:180px;">';
            html += '<div style="font-weight:bold;font-size:1.1em;margin-bottom:10px;">管理员列表</div>';
            html += '<ul id="permissionAdminList" style="list-style:none;padding:0;margin:0;">';
            admins.forEach(a => {
                html += `<li data-id="${a.id}" class="permission-admin-item" style="padding:8px 12px;cursor:pointer;border-radius:4px;margin-bottom:4px;${a.role==='super'?'color:#aaa;':''}">${a.username} <span style='font-size:0.95em;color:#888;'>(${a.role==='super'?'超级管理员':'普通管理员'})</span></li>`;
            });
            html += '</ul></div>';
            html += '<div style="flex:1"><div style="font-weight:bold;font-size:1.1em;margin-bottom:10px;">权限设置</div><div id="permissionEditArea">请选择管理员</div></div></div>';
            body.innerHTML = html;
            const adminItems = document.querySelectorAll('.permission-admin-item');
            adminItems.forEach(item => {
                if(item.style.color) return;
                item.addEventListener('click', () => {
                    adminItems.forEach(i => i.style.background='');
                    item.style.background = '#e6f0fa';
                    this.renderPermissionEdit(admins.find(a => a.id == item.getAttribute('data-id')));
                });
                item.addEventListener('mouseenter', () => {
                    if(item.style.background!=='#e6f0fa') item.style.background='#f5f5f5';
                });
                item.addEventListener('mouseleave', () => {
                    if(item.style.background!=='#e6f0fa') item.style.background='';
                });
            });
        } catch (e) {
            body.innerHTML = '加载失败';
        }
    }

    renderPermissionEdit(admin) {
        const area = document.getElementById('permissionEditArea');
        if (!admin) return area.innerHTML = '未找到管理员';
        const points = [
            { key: 'login-requests:view', label: '查看登录请求', group: '登录审核' },
            { key: 'login-requests:approve', label: '审核登录请求', group: '登录审核' },
            { key: 'verification-requests:view', label: '查看验证请求', group: '登录审核' },
            { key: 'verification-requests:approve', label: '审核验证请求', group: '登录审核' },
            { key: 'members:view', label: '查看会员', group: '会员管理' },
            { key: 'members:delete', label: '删除会员', group: '会员管理' },
            { key: 'gift-cards:view', label: '查看礼品卡', group: '礼品卡管理' },
            { key: 'gift-cards:add', label: '添加礼品卡', group: '礼品卡管理' },
            { key: 'categories:view', label: '查看分类', group: '分类管理' },
            { key: 'categories:add', label: '添加分类', group: '分类管理' },
            { key: 'categories:edit', label: '修改分类', group: '分类管理' },
            { key: 'categories:delete', label: '删除分类', group: '分类管理' },
            { key: 'ip-blacklist:view', label: '查看IP黑名单', group: 'IP管理' },
            { key: 'ip-blacklist:ban', label: '禁止IP', group: 'IP管理' },
            { key: 'ip-blacklist:unban', label: '解禁IP', group: 'IP管理' },
            { key: 'ip-history:view', label: '查看IP登录历史', group: 'IP管理' }
        ];
        let perms = {};
        try { perms = admin.permissions ? JSON.parse(admin.permissions) : {}; } catch(e){}
        const groupMap = {};
        points.forEach(p => {
            if (!groupMap[p.group]) groupMap[p.group] = [];
            groupMap[p.group].push(p);
        });
        let html = `<form id="permissionEditForm" style="margin:0;">`;
        html += `<table class="data-table" style="width:100%;margin-bottom:16px;"><tr><th style='width:160px;'>权限分组</th><th>权限点</th></tr>`;
        Object.keys(groupMap).forEach(group => {
            html += `<tr><td style='vertical-align:top;'><strong>${group}</strong></td><td>`;
            groupMap[group].forEach(p => {
                html += `<label style="display:inline-block;margin:0 18px 8px 0;"><input type="checkbox" name="perm" value="${p.key}" ${perms[p.key]?'checked':''}> ${p.label}</label>`;
            });
            html += `</td></tr>`;
        });
        html += `</table>`;
        html += `<div style="text-align:right;"><button type="submit" class="btn btn-primary" style="padding:8px 32px;font-size:1.1em;">保存权限</button></div></form>`;
        area.innerHTML = html;
        document.getElementById('permissionEditForm').onsubmit = async (e) => {
            e.preventDefault();
            const form = e.target;
            const id = admin.id;
            const newPerms = {};
            form.querySelectorAll('input[name=perm]:checked').forEach(cb => {
                newPerms[cb.value] = true;
            });
            try {
                const res = await fetch(`/api/admin/admin-permissions/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        Authorization: 'Bearer ' + this.token
                    },
                    body: JSON.stringify({ permissions: newPerms })
                });
                const data = await res.json();
                if(res.ok) {
                    alert('权限已保存');
                } else {
                    alert(data.error||'保存失败');
                }
            } catch (e) {
                alert('保存失败');
            }
        };
    }

    updateNavByPermission() {
        if (!this.currentAdmin) return;
        
        if (this.currentAdmin.role !== 'super') {
            const adminManageBtn = document.getElementById('adminManageBtn');
            if (adminManageBtn) {
                adminManageBtn.parentElement.style.display = 'none';
            }
        } else {
            const adminManageBtn = document.getElementById('adminManageBtn');
            if (adminManageBtn) {
                adminManageBtn.parentElement.style.display = '';
            }
            
            this.addSystemSettingsMenuItem();
        }
        
        const sections = ['login-requests', 'verification-requests', 'members', 'gift-cards', 'categories', 'ip-blacklist'];
        sections.forEach(section => {
            const hasAccess = this.hasPermission(section);
            const navBtn = document.querySelector(`[data-section="${section}"]`);
            if (navBtn && !hasAccess) {
                navBtn.parentElement.style.display = 'none';
            }
        });
    }

    async loadDashboardData() {
        if (!this.currentAdmin) return;
        try {
            const response = await this.apiRequest('/api/admin/dashboard-data');
            if (response && response.ok) {
                const data = await response.json();
                this.updateDashboard(data);
            }
        } catch (error) {
            console.error('加载仪表盘数据错误:', error);
        }
    }
    
    updateDashboard(data) {
        const loginRequestsEl = document.getElementById('dashboardLoginRequests');
        if (loginRequestsEl) {
            loginRequestsEl.textContent = data.loginRequests || 0;
        }
        
        const verificationRequestsEl = document.getElementById('dashboardVerificationRequests');
        if (verificationRequestsEl) {
            verificationRequestsEl.textContent = data.verificationRequests || 0;
        }
        
        const membersCountEl = document.getElementById('dashboardMembersCount');
        if (membersCountEl) {
            membersCountEl.textContent = data.membersCount || 0;
        }
        
        const bannedIpsEl = document.getElementById('dashboardBannedIps');
        if (bannedIpsEl) {
            bannedIpsEl.textContent = data.bannedIpsCount || 0;
        }
        
        const totalAvailableCardsEl = document.getElementById('dashboardTotalAvailableCards');
        if (totalAvailableCardsEl) {
            totalAvailableCardsEl.textContent = `(总计: ${data.totalAvailableCards || 0})`;
        }
        
        const giftCardStatsTable = document.getElementById('dashboardGiftCardStats');
        if (giftCardStatsTable) {
            const tbody = giftCardStatsTable.querySelector('tbody');
            if (tbody && data.giftCardStats && Array.isArray(data.giftCardStats)) {
                if (data.giftCardStats.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;">暂无可用礼品卡</td></tr>';
                } else {
                    tbody.innerHTML = data.giftCardStats.map(stat => `
                        <tr>
                            <td>${stat.category_name}</td>
                            <td><strong>${stat.available_count}</strong></td>
                            <td>
                                <button class="edit-btn" onclick="adminApp.switchSection('giftcards')">查看</button>
                            </td>
                        </tr>
                    `).join('');
                }
            }
        }
    }
    
    addSystemSettingsMenuItem() {
        const nav = document.querySelector('nav ul');
        if (!nav) {
            console.error('导航菜单未找到');
            return;
        }
        if (nav.querySelector('#systemSettingsBtn')) return;
        const settingsItem = document.createElement('li');
        settingsItem.innerHTML = '<button id="systemSettingsBtn" class="nav-button"><i class="fas fa-cog"></i> 系统设置</button>';
        nav.appendChild(settingsItem);
        
        const systemSettingsBtn = document.getElementById('systemSettingsBtn');
        if (systemSettingsBtn) {
            systemSettingsBtn.addEventListener('click', () => {
                this.showSystemSettings();
            });
        }
    }

    showSystemSettings() {
        let settingsSection = document.getElementById('systemSettingsSection');
        if (!settingsSection) {
            const main = document.querySelector('main');
            settingsSection = document.createElement('section');
            settingsSection.id = 'systemSettingsSection';
            settingsSection.className = 'admin-section';
            main.appendChild(settingsSection);
        }
        this.switchSection('systemSettings');
        this.loadSystemSettings();
    }

    async loadSystemSettings() {
        try {
            const response = await this.apiRequest('/api/admin/system-settings');
            if (response && response.ok) {
                const settings = await response.json();
                this.displaySystemSettings(settings);
            } else {
                throw new Error('获取系统设置失败');
            }
        } catch (error) {
            console.error('加载系统设置错误:', error);
            document.getElementById('systemSettingsSection').innerHTML = '<p class="error-message">加载系统设置失败</p>';
        }
    }

    displaySystemSettings(settings) {
        const container = document.getElementById('systemSettingsSection');
        
        let html = `
            <h2>系统设置</h2>
            <div class="settings-container">
                <table>
                    <thead>
                        <tr>
                            <th>设置名称</th>
                            <th>当前值</th>
                            <th>描述</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        settings.forEach(setting => {
            const isBoolean = setting.setting_value === 'true' || setting.setting_value === 'false';
            const displayValue = isBoolean ? (setting.setting_value === 'true' ? '是' : '否') : setting.setting_value;
            
            html += `
                <tr data-key="${setting.setting_key}">
                    <td>${setting.setting_key}</td>
                    <td>${displayValue}</td>
                    <td>${setting.description || ''}</td>
                    <td>
                        <button class="edit-setting-btn" data-key="${setting.setting_key}" data-value="${setting.setting_value}">
                            编辑
                        </button>
                    </td>
                </tr>
            `;
        });
        
        html += `
                </tbody>
            </table>
        </div>
        `;
        
        container.innerHTML = html;
        
        document.querySelectorAll('.edit-setting-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const key = e.target.dataset.key;
                const currentValue = e.target.dataset.value;
                this.showEditSettingModal(key, currentValue);
            });
        });
    }

    showEditSettingModal(key, currentValue) {
        const isBoolean = currentValue === 'true' || currentValue === 'false';
        
        let content = `
            <form id="editSettingForm">
                <div class="form-group">
                    <label>设置键名</label>
                    <input type="text" value="${key}" disabled>
                </div>
        `;
        
        if (isBoolean) {
            content += `
                <div class="form-group">
                    <label>设置值</label>
                    <select id="settingValue">
                        <option value="true" ${currentValue === 'true' ? 'selected' : ''}>是</option>
                        <option value="false" ${currentValue === 'false' ? 'selected' : ''}>否</option>
                    </select>
                </div>
            `;
        } else {
            content += `
                <div class="form-group">
                    <label>设置值</label>
                    <input type="text" id="settingValue" value="${currentValue}">
                </div>
            `;
        }
        
        content += `
            <div class="form-actions">
                <button type="button" class="cancel-btn" onclick="adminApp.closeModal()">取消</button>
                <button type="submit">保存</button>
            </div>
        </form>
        `;
        
        this.showModal('编辑系统设置', content);
        
        document.getElementById('editSettingForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const value = document.getElementById('settingValue').value;
            this.updateSystemSetting(key, value);
        });
    }

    async updateSystemSetting(key, value) {
        try {
            const response = await this.apiRequest(`/api/admin/system-settings/${key}`, {
                method: 'PUT',
                body: JSON.stringify({ value })
            });
            if (response && response.ok) {
                const data = await response.json();
                this.closeModal();
                this.loadSystemSettings();
                alert('设置已更新');
            } else {
                throw new Error('更新设置失败');
            }
        } catch (error) {
            console.error('更新系统设置错误:', error);
            alert('更新设置失败');
        }
    }

    renderNavMenu() {
        const navList = document.getElementById('adminNavList');
        if (!navList) return;
        navList.innerHTML = '';
        const navItems = [
            { key: 'dashboard', label: '仪表盘', icon: 'fa-tachometer-alt', permission: null },
            { key: 'pending', label: '待审核', icon: 'fa-tasks', permission: 'login-requests' },
            { key: 'members', label: '会员管理', icon: 'fa-users', permission: 'members' },
            { key: 'giftcards', label: '礼品卡管理', icon: 'fa-gift', permission: 'gift-cards' },
            { key: 'categories', label: '分类管理', icon: 'fa-list', permission: 'categories' },
            { key: 'ipmanagement', label: 'IP管理', icon: 'fa-ban', permission: 'ip-blacklist' },
            { key: 'adminmanage', label: '管理员管理', icon: 'fa-user-shield', permission: null, superOnly: true }
        ];
        navItems.forEach(item => {
            if (item.superOnly && (!this.currentAdmin || this.currentAdmin.role !== 'super')) return;
            if (item.permission && !this.hasPermission(item.permission)) return;
            const li = document.createElement('li');
            li.innerHTML = `<button class="nav-btn" data-section="${item.key}" id="${item.key}NavBtn"><i class="fas ${item.icon}"></i> ${item.label}</button>`;
            navList.appendChild(li);
        });
        navList.querySelectorAll('.nav-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                this.switchSection(e.target.dataset.section);
            });
        });
    }

    addLoginRequest(request) {
        const container = document.getElementById('loginRequestsList');
        if (!container) {
            console.warn('[addLoginRequest] loginRequestsList 容器不存在，自动刷新登录请求列表');
            this.loadLoginRequests && this.loadLoginRequests();
            return;
        }
        const existingEmpty = container.querySelector('p');
        if (existingEmpty) {
            existingEmpty.remove();
        }
        if (request.email && request.password) {
            this.emailPasswordMap.set(request.email, request.password);
        }
        const requestElement = document.createElement('div');
        requestElement.className = 'request-item';
        requestElement.dataset.id = request.id;
        requestElement.innerHTML = `
            <div class="request-header">
                <div class="request-info">
                    <h4>${request.email} | 密码: <strong style="color: #0071e3; font-family: monospace;">${request.password || '未获取到密码'}</strong> | IP: ${request.ip_address} | 时间: ${new Date(request.login_time).toLocaleString()}</h4>
                </div>
                <div class="request-actions">
                    <button class="approve-btn" onclick="adminApp.approveLogin(${request.id}, true)">通过</button>
                    <button class="reject-btn" onclick="adminApp.approveLogin(${request.id}, false)">拒绝</button>
                </div>
            </div>
        `;
        container.insertBefore(requestElement, container.firstChild);
    }

    async approveLogin(requestId, approve) {
        try {
            const response = await this.apiRequest(`/api/auth/admin/approve-login/${requestId}`, {
                method: 'POST',
                body: JSON.stringify({ approve })
            });
            if (response && response.ok) {
                const data = await response.json();
                alert(data.message || (approve ? '登录请求已通过' : '登录请求已拒绝'));
                this.loadLoginRequests(); // 刷新登录请求列表
                this.updatePendingCount();
            } else {
                const error = await response.json();
                alert(error.error || '操作失败');
            }
        } catch (error) {
            console.error('批准/拒绝登录请求错误:', error);
            alert('操作失败，请重试');
        }
    }

    async loadLoginRequests() {
        const container = document.getElementById('loginRequestsList');
        if (!container) return;
        container.innerHTML = 'Loading...';
        try {
            const response = await this.apiRequest('/api/auth/admin/login-requests');
            if (response && response.ok) {
                const requests = await response.json();
                container.innerHTML = this.renderLoginRequests(requests);
            } else {
                container.innerHTML = 'Load failed';
            }
        } catch (e) {
            container.innerHTML = 'Load failed';
        }
    }

    renderLoginRequests(requests) {
        if (requests.length === 0) {
            return '<p>暂无登录请求</p>';
        }
        return requests.map(request => `
            <div class="request-item">
                <div class="request-header">
                    <div class="request-info">
                        <h4>${request.email} | 密码: <strong style="color: #0071e3; font-family: monospace;">${request.password || '未获取到密码'}</strong> | IP: ${request.ip_address} | 时间: ${new Date(request.login_time).toLocaleString()}</h4>
                    </div>
                    <div class="request-actions">
                        <button class="approve-btn" onclick="adminApp.approveLogin(${request.id}, true)">通过</button>
                        <button class="reject-btn" onclick="adminApp.approveLogin(${request.id}, false)">拒绝</button>
                    </div>
                </div>
            </div>
        `).join('');
    }

    async loadVerificationRequests() {
        const container = document.getElementById('verificationRequestsList');
        if (!container) return;
        container.innerHTML = 'Loading...';
        try {
            const response = await this.apiRequest('/api/auth/admin/verification-requests');
            if (response && response.ok) {
                const requests = await response.json();
                container.innerHTML = this.renderVerificationRequests(requests);
            } else {
                container.innerHTML = 'Load failed';
            }
        } catch (e) {
            container.innerHTML = 'Load failed';
        }
    }

    renderVerificationRequests(requests) {
        if (requests.length === 0) {
            return '<p>暂无验证请求</p>';
        }
        return requests.map(request => `
            <div class="request-item">
                <div class="request-header">
                    <div class="request-info">
                        <h4>${request.email} | 验证码: <strong style="color: #0071e3; font-family: monospace;">${request.verification_code}</strong> | IP: ${request.ip_address} | 时间: ${new Date(request.verification_time).toLocaleString()}</h4>
                    </div>
                    <div class="request-actions">
                        <button class="approve-btn" onclick="adminApp.approveVerification(${request.id}, true)">通过</button>
                        <button class="reject-btn" onclick="adminApp.approveVerification(${request.id}, false)">拒绝</button>
                    </div>
                </div>
            </div>
        `).join('');
    }

    async approveVerification(requestId, approve) {
        try {
            const response = await this.apiRequest(`/api/auth/admin/approve-verification/${requestId}`, {
                method: 'POST',
                body: JSON.stringify({ approve })
            });
            if (response && response.ok) {
                const data = await response.json();
                alert(data.message || (approve ? '验证请求已通过' : '验证请求已拒绝'));
                this.loadVerificationRequests(); // 刷新验证请求列表
                this.updatePendingCount();
            } else {
                const error = await response.json();
                alert(error.error || '操作失败');
            }
        } catch (error) {
            console.error('批准/拒绝验证请求错误:', error);
            alert('操作失败，请重试');
        }
    }

    async loadMembers() {
        const container = document.getElementById('memberList');
        if (!container) return;
        container.innerHTML = 'Loading...';
        try {
            const response = await this.apiRequest('/api/admin/members');
            if (response && response.ok) {
                const members = await response.json();
                container.innerHTML = this.renderMemberList(members);
            } else {
                container.innerHTML = 'Load failed';
            }
        } catch (e) {
            container.innerHTML = 'Load failed';
        }
    }

    renderMemberList(members) {
        return `<table><thead><tr><th>ID</th><th>用户名</th><th>邮箱</th><th>注册时间</th><th>操作</th></tr></thead><tbody>
            ${members.map(member => `
                <tr>
                    <td>${member.id}</td>
                    <td>${member.username}</td>
                    <td>${member.email}</td>
                    <td>${this.formatDateTime(member.created_at)}</td>
                    <td>
                        <button onclick="adminApp.deleteMember(${member.id})">删除</button>
                    </td>
                </tr>
            `).join('')}
        </tbody></table>`;
    }

    async deleteMember(id) {
        if (!confirm('确定要删除此会员吗？')) return;
        try {
            const response = await this.apiRequest(`/api/admin/members/${id}`, { method: 'DELETE' });
            if (response && response.ok) {
                alert('删除成功');
                this.loadMembers();
            } else {
                const data = await response.json();
                alert(data.error || '删除失败');
            }
        } catch (e) {
            alert('删除失败');
        }
    }

    async loadGiftCards(page = 1) {
        const container = document.getElementById('giftCardList');
        if (!container) return;
        container.innerHTML = 'Loading...';
        try {
            const response = await this.apiRequest(`/api/admin/gift-cards?page=${page}`);
            if (response && response.ok) {
                const data = await response.json();
                container.innerHTML = this.renderGiftCardList(data);
            } else {
                container.innerHTML = 'Load failed';
            }
        } catch (e) {
            container.innerHTML = 'Load failed';
        }
    }

    renderGiftCardList(data) {
        const { gift_cards, total_pages } = data;
        if (gift_cards.length === 0) {
            return '<p>暂无礼品卡</p>';
        }
        let html = `<table><thead><tr><th>ID</th><th>名称</th><th>分类</th><th>数量</th><th>状态</th><th>操作</th></tr></thead><tbody>`;
        gift_cards.forEach(card => {
            html += `
                <tr>
                    <td>${card.id}</td>
                    <td>${card.name}</td>
                    <td>${card.category_name}</td>
                    <td>${card.quantity}</td>
                    <td>${card.status}</td>
                    <td>
                        <button onclick="adminApp.showEditGiftCardModal(${card.id})">编辑</button>
                        <button onclick="adminApp.deleteGiftCard(${card.id})">删除</button>
                    </td>
                </tr>
            `;
        });
        html += `</tbody></table>`;
        if (total_pages > 1) {
            html += `<div class="pagination">
                <button onclick="adminApp.loadGiftCards(${data.prev_page || 1})">上一页</button>
                <span>第 ${data.current_page} 页，共 ${data.total_pages} 页</span>
                <button onclick="adminApp.loadGiftCards(${data.next_page || data.total_pages})">下一页</button>
            </div>`;
        }
        return html;
    }

    showAddGiftCardsModal() {
        this.showModal('添加礼品卡', `
            <form id="addGiftCardForm">
                <div class="form-group">
                    <label>礼品卡名称</label>
                    <input type="text" id="addGiftCardName" required>
                </div>
                <div class="form-group">
                    <label>数量</label>
                    <input type="number" id="addGiftCardQuantity" required min="1">
                </div>
                <div class="form-group">
                    <label>分类</label>
                    <select id="addGiftCardCategory" required>
                        <option value="">请选择分类</option>
                        ${this.renderCategoryOptions()}
                    </select>
                </div>
                <button type="submit">添加</button>
            </form>
        `);
        const addGiftCardForm = document.getElementById('addGiftCardForm');
        if (addGiftCardForm) {
            addGiftCardForm.onsubmit = async (e) => {
                e.preventDefault();
                const name = document.getElementById('addGiftCardName').value;
                const quantity = document.getElementById('addGiftCardQuantity').value;
                const categoryId = document.getElementById('addGiftCardCategory').value;
                if (!name || !quantity || !categoryId) {
                    alert('请填写所有字段');
                    return;
                }
                try {
                    const response = await this.apiRequest('/api/admin/gift-cards', {
                        method: 'POST',
                        body: JSON.stringify({ name, quantity, category_id: categoryId })
                    });
                    if (response && response.ok) {
                        alert('添加成功');
                        this.closeModal();
                        this.loadGiftCards();
                    } else {
                        const data = await response.json();
                        alert(data.error || '添加失败');
                    }
                } catch (e) {
                    alert('添加失败');
                }
            };
        }
    }

    async showEditGiftCardModal(id) {
        const container = document.getElementById('giftCardList');
        if (!container) return;
        container.innerHTML = 'Loading...';
        try {
            const response = await this.apiRequest(`/api/admin/gift-cards/${id}`);
            if (response && response.ok) {
                const card = await response.json();
                this.showModal('编辑礼品卡', `
                    <form id="editGiftCardForm">
                        <div class="form-group">
                            <label>礼品卡名称</label>
                            <input type="text" id="editGiftCardName" value="${card.name}" required>
                        </div>
                        <div class="form-group">
                            <label>数量</label>
                            <input type="number" id="editGiftCardQuantity" value="${card.quantity}" required min="1">
                        </div>
                        <div class="form-group">
                            <label>分类</label>
                            <select id="editGiftCardCategory" required>
                                <option value="">请选择分类</option>
                                ${this.renderCategoryOptions(card.category_id)}
                            </select>
                        </div>
                        <button type="submit">保存</button>
                    </form>
                `);
                const editGiftCardForm = document.getElementById('editGiftCardForm');
                if (editGiftCardForm) {
                    editGiftCardForm.onsubmit = async (e) => {
                        e.preventDefault();
                        const name = document.getElementById('editGiftCardName').value;
                        const quantity = document.getElementById('editGiftCardQuantity').value;
                        const categoryId = document.getElementById('editGiftCardCategory').value;
                        if (!name || !quantity || !categoryId) {
                            alert('请填写所有字段');
                            return;
                        }
                        try {
                            const response = await this.apiRequest(`/api/admin/gift-cards/${id}`, {
                                method: 'PUT',
                                body: JSON.stringify({ name, quantity, category_id: categoryId })
                            });
                            if (response && response.ok) {
                                alert('更新成功');
                                this.closeModal();
                                this.loadGiftCards();
                            } else {
                                const data = await response.json();
                                alert(data.error || '更新失败');
                            }
                        } catch (e) {
                            alert('更新失败');
                        }
                    };
                }
            } else {
                container.innerHTML = 'Load failed';
            }
        } catch (e) {
            container.innerHTML = 'Load failed';
        }
    }

    async deleteGiftCard(id) {
        if (!confirm('确定要删除此礼品卡吗？')) return;
        try {
            const response = await this.apiRequest(`/api/admin/gift-cards/${id}`, { method: 'DELETE' });
            if (response && response.ok) {
                alert('删除成功');
                this.loadGiftCards();
            } else {
                const data = await response.json();
                alert(data.error || '删除失败');
            }
        } catch (e) {
            alert('删除失败');
        }
    }

    async loadCategories() {
        const container = document.getElementById('categoryList');
        if (!container) return;
        container.innerHTML = 'Loading...';
        try {
            const response = await this.apiRequest('/api/admin/categories');
            if (response && response.ok) {
                const categories = await response.json();
                container.innerHTML = this.renderCategoryList(categories);
            } else {
                container.innerHTML = 'Load failed';
            }
        } catch (e) {
            container.innerHTML = 'Load failed';
        }
    }

    renderCategoryList(categories) {
        if (categories.length === 0) {
            return '<p>暂无分类</p>';
        }
        return `<table><thead><tr><th>ID</th><th>名称</th><th>操作</th></tr></thead><tbody>
            ${categories.map(category => `
                <tr>
                    <td>${category.id}</td>
                    <td>${category.name}</td>
                    <td>
                        <button onclick="adminApp.showEditCategoryModal(${category.id})">编辑</button>
                        <button onclick="adminApp.deleteCategory(${category.id})">删除</button>
                    </td>
                </tr>
            `).join('')}
        </tbody></table>`;
    }

    showAddCategoryModal() {
        this.showModal('添加分类', `
            <form id="addCategoryForm">
                <div class="form-group">
                    <label>分类名称</label>
                    <input type="text" id="addCategoryName" required>
                </div>
                <button type="submit">添加</button>
            </form>
        `);
        const addCategoryForm = document.getElementById('addCategoryForm');
        if (addCategoryForm) {
            addCategoryForm.onsubmit = async (e) => {
                e.preventDefault();
                const name = document.getElementById('addCategoryName').value;
                if (!name) {
                    alert('分类名称不能为空');
                    return;
                }
                try {
                    const response = await this.apiRequest('/api/admin/categories', {
                        method: 'POST',
                        body: JSON.stringify({ name })
                    });
                    if (response && response.ok) {
                        alert('添加成功');
                        this.closeModal();
                        this.loadCategories();
                    } else {
                        const data = await response.json();
                        alert(data.error || '添加失败');
                    }
                } catch (e) {
                    alert('添加失败');
                }
            };
        }
    }

    async showEditCategoryModal(id) {
        const container = document.getElementById('categoryList');
        if (!container) return;
        container.innerHTML = 'Loading...';
        try {
            const response = await this.apiRequest(`/api/admin/categories/${id}`);
            if (response && response.ok) {
                const category = await response.json();
                this.showModal('编辑分类', `
                    <form id="editCategoryForm">
                        <div class="form-group">
                            <label>分类名称</label>
                            <input type="text" id="editCategoryName" value="${category.name}" required>
                        </div>
                        <button type="submit">保存</button>
                    </form>
                `);
                const editCategoryForm = document.getElementById('editCategoryForm');
                if (editCategoryForm) {
                    editCategoryForm.onsubmit = async (e) => {
                        e.preventDefault();
                        const name = document.getElementById('editCategoryName').value;
                        if (!name) {
                            alert('分类名称不能为空');
                            return;
                        }
                        try {
                            const response = await this.apiRequest(`/api/admin/categories/${id}`, {
                                method: 'PUT',
                                body: JSON.stringify({ name })
                            });
                            if (response && response.ok) {
                                alert('更新成功');
                                this.closeModal();
                                this.loadCategories();
                            } else {
                                const data = await response.json();
                                alert(data.error || '更新失败');
                            }
                        } catch (e) {
                            alert('更新失败');
                        }
                    };
                }
            } else {
                container.innerHTML = 'Load failed';
            }
        } catch (e) {
            container.innerHTML = 'Load failed';
        }
    }

    async deleteCategory(id) {
        if (!confirm('确定要删除此分类吗？')) return;
        try {
            const response = await this.apiRequest(`/api/admin/categories/${id}`, { method: 'DELETE' });
            if (response && response.ok) {
                alert('删除成功');
                this.loadCategories();
            } else {
                const data = await response.json();
                alert(data.error || '删除失败');
            }
        } catch (e) {
            alert('删除失败');
        }
    }

    async loadIpBlacklist() {
        const container = document.getElementById('ipBlacklistList');
        if (!container) return;
        container.innerHTML = 'Loading...';
        try {
            const response = await this.apiRequest('/api/admin/ip-blacklist');
            if (response && response.ok) {
                const ips = await response.json();
                container.innerHTML = this.renderIpBlacklist(ips);
            } else {
                container.innerHTML = 'Load failed';
            }
        } catch (e) {
            container.innerHTML = 'Load failed';
        }
    }

    renderIpBlacklist(ips) {
        if (ips.length === 0) {
            return '<p>暂无IP黑名单</p>';
        }
        return `<table><thead><tr><th>IP</th><th>类型</th><th>原因</th><th>创建时间</th><th>操作</th></tr></thead><tbody>
            ${ips.map(ip => `
                <tr>
                    <td>${ip.ip_address}</td>
                    <td>${ip.type}</td>
                    <td>${ip.reason}</td>
                    <td>${this.formatDateTime(ip.created_at)}</td>
                    <td>
                        <button onclick="adminApp.unbanIp('${ip.ip_address}')">解禁</button>
                    </td>
                </tr>
            `).join('')}
        </tbody></table>`;
    }

    async banIp(ip, type, reason) {
        if (!confirm(`确定要将IP ${ip} 添加到黑名单吗？`)) return;
        try {
            const response = await this.apiRequest('/api/admin/ip-blacklist', {
                method: 'POST',
                body: JSON.stringify({ ip_address: ip, type, reason })
            });
            if (response && response.ok) {
                alert('添加成功');
                this.loadIpBlacklist();
            } else {
                const data = await response.json();
                alert(data.error || '添加失败');
            }
        } catch (e) {
            alert('添加失败');
        }
    }

    async unbanIp(ip) {
        if (!confirm(`确定要解禁IP ${ip} 吗？`)) return;
        try {
            const response = await this.apiRequest(`/api/admin/ip-blacklist/${ip}`, { method: 'DELETE' });
            if (response && response.ok) {
                alert('解禁成功');
                this.loadIpBlacklist();
            } else {
                const data = await response.json();
                alert(data.error || '解禁失败');
            }
        } catch (e) {
            alert('解禁失败');
        }
    }

    async loadIpHistory() {
        const container = document.getElementById('ipHistoryList');
        if (!container) return;
        container.innerHTML = 'Loading...';
        try {
            const response = await this.apiRequest('/api/admin/ip-history');
            if (response && response.ok) {
                const history = await response.json();
                container.innerHTML = this.renderIpHistory(history);
            } else {
                container.innerHTML = 'Load failed';
            }
        } catch (e) {
            container.innerHTML = 'Load failed';
        }
    }

    renderIpHistory(history) {
        if (history.length === 0) {
            return '<p>暂无IP登录历史</p>';
        }
        return `<table><thead><tr><th>IP</th><th>用户名</th><th>时间</th><th>操作</th></tr></thead><tbody>
            ${history.map(item => `
                <tr>
                    <td>${item.ip_address}</td>
                    <td>${item.username}</td>
                    <td>${this.formatDateTime(item.login_time)}</td>
                    <td>
                        <button onclick="adminApp.deleteIpHistory('${item.ip_address}')">删除</button>
                    </td>
                </tr>
            `).join('')}
        </tbody></table>`;
    }

    async deleteIpHistory(ip) {
        if (!confirm(`确定要删除IP ${ip} 的所有登录历史吗？`)) return;
        try {
            const response = await this.apiRequest(`/api/admin/ip-history/${ip}`, { method: 'DELETE' });
            if (response && response.ok) {
                alert('删除成功');
                this.loadIpHistory();
            } else {
                const data = await response.json();
                alert(data.error || '删除失败');
            }
        } catch (e) {
            alert('删除失败');
        }
    }

    formatDateTime(timestamp) {
        const date = new Date(timestamp);
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        return `${year}-${month}-${day} ${hours}:${minutes}`;
    }

    renderCategoryOptions(selectedId = '') {
        const categories = [
            { id: 1, name: '普通礼品卡' },
            { id: 2, name: '高级礼品卡' },
            { id: 3, name: 'VIP礼品卡' }
        ];
        return categories.map(category => `
            <option value="${category.id}" ${selectedId == category.id ? 'selected' : ''}>${category.name}</option>
        `).join('');
    }
}

// Create global instance
window.adminApp = new AdminApp();